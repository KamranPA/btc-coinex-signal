name: CoinEx Signal Bot - Production

on:
  schedule:
    - cron: '*/15 * * * *'  # Ù‡Ø± 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no real signals)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  run-signal-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests python-dotenv ta-lib

    - name: Debug strategy execution
      run: |
        echo "=== Debugging Strategy Execution ==="
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
        echo "#!/usr/bin/env python3" > debug_strategy.py
        echo "import logging" >> debug_strategy.py
        echo "logging.basicConfig(level=logging.INFO)" >> debug_strategy.py
        echo "logger = logging.getLogger(__name__)" >> debug_strategy.py
        echo "" >> debug_strategy.py
        echo "def debug_strategy():" >> debug_strategy.py
        echo "    try:" >> debug_strategy.py
        echo "        from services.coinex_api import CoinExAPI" >> debug_strategy.py
        echo "        from strategies.mutanabby_strategy import MutanabbyStrategy" >> debug_strategy.py
        echo "" >> debug_strategy.py
        echo "        api = CoinExAPI()" >> debug_strategy.py
        echo "        " >> debug_strategy.py
        echo "        # ØªØ³Øª Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API" >> debug_strategy.py
        echo "        logger.info(\"Testing API data retrieval...\")" >> debug_strategy.py
        echo "        market_data = api.get_market_data('BTCUSDT')" >> debug_strategy.py
        echo "        logger.info(f\"Market data: {market_data}\")" >> debug_strategy.py
        echo "" >> debug_strategy.py
        echo "        # ØªØ³Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ" >> debug_strategy.py
        echo "        logger.info(\"Testing strategy...\")" >> debug_strategy.py
        echo "        " >> debug_strategy.py
        echo "        # Ø³Ø¹ÛŒ Ú©Ù†ÛŒÙ… Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø±Ø§ Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù initialize Ú©Ù†ÛŒÙ…" >> debug_strategy.py
        echo "        try:" >> debug_strategy.py
        echo "            strategy = MutanabbyStrategy(api)" >> debug_strategy.py
        echo "            logger.info(\"Strategy initialized with API\")" >> debug_strategy.py
        echo "        except TypeError as e:" >> debug_strategy.py
        echo "            logger.warning(f\"Strategy with API failed: {e}\")" >> debug_strategy.py
        echo "            strategy = MutanabbyStrategy()" >> debug_strategy.py
        echo "            logger.info(\"Strategy initialized without API\")" >> debug_strategy.py
        echo "" >> debug_strategy.py
        echo "        # ØªØ³Øª ØªÙ…Ø§Ù… Ù…ØªØ¯Ù‡Ø§ÛŒ Ù…Ù…Ú©Ù†" >> debug_strategy.py
        echo "        methods = ['generate_signals', 'execute', 'run', 'analyze', 'get_signals']" >> debug_strategy.py
        echo "        for method_name in methods:" >> debug_strategy.py
        echo "            if hasattr(strategy, method_name):" >> debug_strategy.py
                echo "                logger.info(f\"Testing method: {method_name}\")" >> debug_strategy.py
        echo "                method = getattr(strategy, method_name)" >> debug_strategy.py
        echo "                " >> debug_strategy.py
        echo "                # Ø§Ú¯Ø± Ù…ØªØ¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø¯Ø§Ø±Ø¯" >> debug_strategy.py
        echo "                if method_name == 'generate_signals':" >> debug_strategy.py
        echo "                    result = method(market_data)" >> debug_strategy.py
        echo "                else:" >> debug_strategy.py
        echo "                    result = method()" >> debug_strategy.py
        echo "                " >> debug_strategy.py
        echo "                logger.info(f\"Method {method_name} result: {result}\")" >> debug_strategy.py
        echo "                " >> debug_strategy.py
        echo "        return True" >> debug_strategy.py
        echo "    " >> debug_strategy.py
        echo "    except Exception as e:" >> debug_strategy.py
        echo "        logger.error(f\"Error in debug: {e}\")" >> debug_strategy.py
        echo "        import traceback" >> debug_strategy.py
        echo "        logger.error(traceback.format_exc())" >> debug_strategy.py
        echo "        return False" >> debug_strategy.py
        echo "" >> debug_strategy.py
        echo "if __name__ == \"__main__\":" >> debug_strategy.py
        echo "    debug_strategy()" >> debug_strategy.py
        
        echo "Running strategy debug..."
        python debug_strategy.py

    - name: Create production main.py
      run: |
        echo "=== Creating Production Main.py ==="
        
        echo "#!/usr/bin/env python3" > main.py
        echo "import json" >> main.py
        echo "import os" >> main.py
        echo "import sys" >> main.py
        echo "import logging" >> main.py
        echo "from datetime import datetime" >> main.py
        echo "" >> main.py
        echo "# Setup logging" >> main.py
        echo "logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')" >> main.py
        echo "logger = logging.getLogger(__name__)" >> main.py
        echo "" >> main.py
        echo "def main():" >> main.py
        echo "    try:" >> main.py
        echo "        logger.info(f\"ğŸ’° Signal Bot started at {datetime.now()}\")" >> main.py
        echo "" >> main.py
        echo "        # Import and initialize components" >> main.py
        echo "        from services.coinex_api import CoinExAPI" >> main.py
        echo "        from services.telegram_bot import TelegramBot" >> main.py
        echo "        from strategies.mutanabby_strategy import MutanabbyStrategy" >> main.py
        echo "" >> main.py
        echo "        api = CoinExAPI()" >> main.py
        echo "        telegram_bot = TelegramBot()" >> main.py
        echo "        " >> main.py
        echo "        # Initialize strategy" >> main.py
        echo "        try:" >> main.py
        echo "            strategy = MutanabbyStrategy(api)" >> main.py
        echo "            logger.info(\"âœ… Strategy initialized with API\")" >> main.py
        echo "        except TypeError:" >> main.py
        echo "            strategy = MutanabbyStrategy()" >> main.py
        echo "            logger.info(\"âœ… Strategy initialized without API\")" >> main.py
        echo "" >> main.py
        echo "        logger.info(\"âœ… All components initialized\")" >> main.py
        echo "" >> main.py
        echo "        # Execute strategy - ONLY use real methods" >> main.py
        echo "        logger.info(\"ğŸ” Analyzing market conditions...\")" >> main.py
        echo "        " >> main.py
        echo "        signals = None" >> main.py
        echo "        " >> main.py
        echo "        # Try to get REAL signals first" >> main.py
        echo "        market_data = api.get_market_data('BTCUSDT')" >> main.py
        echo "        " >> main.py
        echo "        if hasattr(strategy, 'generate_signals'):" >> main.py
        echo "            try:" >> main.py
        echo "                signals = strategy.generate_signals(market_data)" >> main.py
        echo "                logger.info(\"âœ… Real generate_signals executed\")" >> main.py
        echo "            except Exception as e:" >> main.py
        echo "                logger.warning(f\"âš  generate_signals failed: {e}\")" >> main.py
        echo "        " >> main.py
        echo "        # Try other real methods" >> main.py
        echo "        if signals is None:" >> main.py
        echo "            real_methods = ['execute', 'run', 'analyze', 'get_signals']" >> main.py
        echo "            for method_name in real_methods:" >> main.py
        echo "                if hasattr(strategy, method_name):" >> main.py
        echo "                    try:" >> main.py
        echo "                        method = getattr(strategy, method_name)" >> main.py
        echo "                        signals = method()" >> main.py
        echo "                        logger.info(f\"âœ… Real method executed: {method_name}\")" >> main.py
        echo "                        break" >> main.py
        echo "                    except Exception as e:" >> main.py
        echo "                        logger.warning(f\"âš  Method {method_name} failed: {e}\")" >> main.py
        echo "        " >> main.py
        echo "        # ONLY create test signal if in test mode" >> main.py
        echo "        if signals is None and '--test' in sys.argv:" >> main.py
        echo "            logger.warning(\"âš  No real signals found, creating TEST signal\")" >> main.py
        echo "            signals = [" >> main.py
        echo "                {" >> main.py
        echo "                    'symbol': 'BTCUSDT'," >> main.py
        echo "                    'action': 'BUY'," >> main.py
        echo "                    'price': 50000," >> main.py
        echo "                    'timestamp': datetime.now().isoformat()," >> main.py
        echo "                    'confidence': 0.8," >> main.py
        echo "                    'message': 'TEST SIGNAL - Bullish pattern detected'" >> main.py
        echo "                }" >> main.py
        echo "            ]" >> main.py
        echo "        elif signals is None:" >> main.py
        echo "            logger.info(\"ğŸ“­ No signals found\")" >> main.py
        echo "            return True" >> main.py
        echo "" >> main.py
        echo "        if signals and len(signals) > 0:" >> main.py
        echo "            logger.info(f\"ğŸ¯ Found {len(signals)} signals\")" >> main.py
        echo "            " >> main.py
        echo "            # Send signals via Telegram" >> main.py
        echo "            if '--test' not in sys.argv:" >> main.py
        echo "                telegram_methods = ['send_signals', 'send_message', 'send_signal', 'notify']" >> main.py
        echo "                sent = False" >> main.py
        echo "                for method_name in telegram_methods:" >> main.py
        echo "                    if hasattr(telegram_bot, method_name):" >> main.py
        echo "                        try:" >> main.py
        echo "                            method = getattr(telegram_bot, method_name)" >> main.py
        echo "                            method(signals)" >> main.py
        echo "                            logger.info(f\"ğŸ“¤ Signals sent via {method_name}\")" >> main.py
        echo "                            sent = True" >> main.py
        echo "                            break" >> main.py
        echo "                        except Exception as e:" >> main.py
        echo "                            logger.warning(f\"âš  Telegram method {method_name} failed: {e}\")" >> main.py
        echo "                " >> main.py
        echo "                if not sent:" >> main.py
        echo "                    logger.error(\"âŒ No working Telegram method found\")" >> main.py
        echo "            else:" >> main.py
        echo "                logger.info(\"ğŸ§ª Test mode - Signals not sent\")" >> main.py
        echo "                for signal in signals:" >> main.py
        echo "                    logger.info(f\"TEST SIGNAL: {signal}\")" >> main.py
        echo "        else:" >> main.py
        echo "            logger.info(\"ğŸ“­ No signals found\")" >> main.py
        echo "" >> main.py
        echo "        return True" >> main.py
        echo "" >> main.py
        echo "    except Exception as e:" >> main.py
        echo "        logger.error(f\"âŒ Error in main execution: {e}\")" >> main.py
        echo "        import traceback" >> main.py
        echo "        logger.error(traceback.format_exc())" >> main.py
        echo "        return False" >> main.py
        echo "" >> main.py
        echo "if __name__ == \"__main__\":" >> main.py
        echo "    success = main()" >> main.py
        echo "    sys.exit(0 if success else 1)" >> main.py

        echo "Production main.py created successfully"

    - name: Run Signal Bot
      env:
        COINEX_ACCESS_ID: ${{ secrets.COINEX_ACCESS_ID }}
        COINEX_SECRET_KEY: ${{ secrets.COINEX_SECRET_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        echo "=== Starting Signal Bot ==="
        echo "Telegram Token: ${TELEGRAM_BOT_TOKEN:0:10}..."
        echo "Telegram Chat ID: $TELEGRAM_CHAT_ID"
        echo "Test Mode: $TEST_MODE"
        
        if [ "$TEST_MODE" = "true" ]; then
            echo "ğŸŸ¡ Running in TEST mode - Test signals will be created but not sent"
            python main.py --test
        else
            echo "ğŸŸ¢ Running in PRODUCTION mode - Only real signals will be processed"
            python main.py
        fi

    - name: Send completion notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
      run: |
        echo "=== Sending Completion Notification ==="
        
        mkdir -p .github/scripts
        
        echo "import requests" > .github/scripts/notify.py
        echo "import os" >> .github/scripts/notify.py
        echo "from datetime import datetime" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "def send_notification():" >> .github/scripts/notify.py
        echo "    token = os.getenv('TELEGRAM_BOT_TOKEN')" >> .github/scripts/notify.py
        echo "    chat_id = os.getenv('TELEGRAM_CHAT_ID')" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    if not token or not chat_id:" >> .github/scripts/notify.py
        echo "        print('Telegram credentials missing')" >> .github/scripts/notify.py
        echo "        return False" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    workflow = os.getenv('GITHUB_WORKFLOW', 'Unknown')" >> .github/scripts/notify.py
        echo "    run_id = os.getenv('GITHUB_RUN_ID', 'Unknown')" >> .github/scripts/notify.py
        echo "    repo = os.getenv('GITHUB_REPOSITORY', 'Unknown')" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    status = 'Success'" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    message = f\"\"\"" >> .github/scripts/notify.py
        echo "ğŸ¤– <b>Signal Bot Execution Completed</b>" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "ğŸ“Š <b>Workflow:</b> {workflow}" >> .github/scripts/notify.py
        echo "ğŸ·ï¸ <b>Run ID:</b> #{run_id}" >> .github/scripts/notify.py
        echo "ğŸ“ <b>Repository:</b> {repo}" >> .github/scripts/notify.py
        echo "â° <b>Time:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}" >> .github/scripts/notify.py
        echo "âœ… <b>Status:</b> {status}" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "ğŸ”— <a href=\\\"https://github.com/{repo}/actions/runs/{run_id}\\\">View Details</a>" >> .github/scripts/notify.py
        echo "    \"\"\"" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    url = f\"https://api.telegram.org/bot{token}/sendMessage\"" >> .github/scripts/notify.py
        echo "    payload = {" >> .github/scripts/notify.py
        echo "        'chat_id': chat_id," >> .github/scripts/notify.py
        echo "        'text': message," >> .github/scripts/notify.py
        echo "        'parse_mode': 'HTML'," >> .github/scripts/notify.py
        echo "        'disable_web_page_preview': True" >> .github/scripts/notify.py
        echo "    }" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    try:" >> .github/scripts/notify.py
        echo "        response = requests.post(url, json=payload, timeout=10)" >> .github/scripts/notify.py
        echo "        return response.status_code == 200" >> .github/scripts/notify.py
        echo "    except Exception:" >> .github/scripts/notify.py
        echo "        return False" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "if __name__ == \"__main__\":" >> .github/scripts/notify.py
        echo "    send_notification()" >> .github/scripts/notify.py
        
        python .github/scripts/notify.py

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Final cleanup
      run: |
        echo "ğŸ¤– Signal Bot workflow completed"
        echo "â° Time: $(date)"
        echo "ğŸ†” Run ID: ${{ github.run_id }}"
