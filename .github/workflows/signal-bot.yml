name: CoinEx Signal Bot with Structure Check

on:
  schedule:
    - cron: '*/15 * * * *'  # Ù‡Ø± 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      test_mode:
        description: 'Enable test mode (no signals sent)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      comprehensive_test:
        description: 'Run comprehensive debug test'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-structure:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Analyze project structure
      run: |
        echo "ğŸ” Analyzing project structure..."
        echo ""
        echo "ğŸ“ Current working directory: $(pwd)"
        echo ""
        
        echo "ğŸ“Š Full directory structure:"
        ls -la
        echo ""
        
        echo "ğŸ§© Checking required directories:"
        for dir in services strategies utils config debug logs tests .github/scripts; do
          if [ -d "$dir" ]; then
            echo "âœ… Directory exists: $dir"
            echo "   Files in $dir: $(ls -1 $dir | tr '\n' ' ')"
          else
            echo "âŒ Directory missing: $dir"
          fi
          echo ""
        done
        
        echo "ğŸ“„ Checking required files:"
        required_files=(
          "main.py"
          "config/config.py"
          "services/coinex_api.py"
          "services/telegram_bot.py"
          "services/debug_service.py"
          "strategies/mutanabby_strategy.py"
          "utils/error_handler.py"
          "utils/performance_monitor.py"
          "utils/logger.py"
          "requirements.txt"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… File exists: $file"
            echo "   Size: $(wc -l < "$file") lines"
          else
            echo "âŒ File missing: $file"
          fi
          echo ""
        done
        
        echo "ğŸ Checking Python package structure:"
        for dir in services strategies utils config; do
          if [ -d "$dir" ]; then
            if [ -f "$dir/__init__.py" ]; then
              echo "âœ… $dir/__init__.py exists"
            else
              echo "âš ï¸  $dir/__init__.py missing - creating it"
              touch "$dir/__init__.py"
            fi
          fi
        done
        
        echo ""
        echo "ğŸ“‹ Python import test:"
        python -c "
import sys
print('Python path:')
for p in sys.path:
    print(f'  {p}')
print()

# Test basic imports
try:
    import pandas as pd
    print('âœ… pandas imported successfully')
except ImportError as e:
    print(f'âŒ pandas import failed: {e}')

try:
    import numpy as np
    print('âœ… numpy imported successfully')
except ImportError as e:
    print(f'âŒ numpy import failed: {e}')

try:
    import requests
    print('âœ… requests imported successfully')
except ImportError as e:
    print(f'âŒ requests import failed: {e}')
        "

    - name: Create missing directories
      run: |
        echo "ğŸ“ Creating missing directories..."
        mkdir -p logs debug/debug_reports debug/historical_signals .github/scripts
        echo "âœ… Directories created"

    - name: Create __init__.py files
      run: |
        echo "ğŸ“¦ Creating __init__.py files for Python packages..."
        for dir in services strategies utils config; do
          if [ -d "$dir" ] && [ ! -f "$dir/__init__.py" ]; then
            echo "Creating $dir/__init__.py"
            echo "# Package initialization" > "$dir/__init__.py"
          fi
        done
        echo "âœ… __init__.py files created"

    - name: Verify file structure
      run: |
        echo "ğŸ” Final structure verification:"
        echo ""
        echo "ğŸ—ï¸ Project structure:"
        find . -name "*.py" -o -name "*.yml" -o -name "*.yaml" -o -name "requirements.txt" | sort | head -20
        echo ""
        
        echo "ğŸ“¦ Python packages:"
        for dir in services strategies utils config; do
          if [ -d "$dir" ]; then
            echo "$dir/: $(find $dir -name "*.py" | wc -l) Python files"
            find $dir -name "*.py" -exec basename {} \; | sort | tr '\n' ' '
            echo ""
          fi
        done

  run-signal-bot:
    runs-on: ubuntu-latest
    needs: check-structure
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          echo "âš ï¸ requirements.txt not found, installing default packages"
          pip install requests pandas numpy python-telegram-bot schedule
        fi
        
        echo "âœ… Dependencies installed:"
        pip list | grep -E "(requests|pandas|numpy|telegram|schedule)"

    - name: Test Python imports
      run: |
        echo "ğŸ Testing Python imports..."
        
        # ØªØ³Øª Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        import_test_script=$(cat << 'EOF'
import sys
import os

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ Ø¨Ù‡ Python path
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

print("ğŸ”§ Testing imports...")
print(f"Working directory: {os.getcwd()}")
print(f"Python path: {sys.path}")

# ØªØ³Øª Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
modules_to_test = [
    ("services.coinex_api", "CoinExAPI"),
    ("services.telegram_bot", "TelegramBot"),
    ("services.debug_service", "DebugService"),
    ("strategies.mutanabby_strategy", "MutanabbyStrategy"),
    ("utils.error_handler", "error_handler"),
    ("utils.performance_monitor", "performance_monitor"),
    ("config.config", "SYMBOLS"),
]

success_count = 0
total_count = len(modules_to_test)

for module_path, attribute in modules_to_test:
    try:
        if attribute:
            module = __import__(module_path, fromlist=[attribute])
            obj = getattr(module, attribute)
            print(f"âœ… {module_path}.{attribute} imported successfully")
            success_count += 1
        else:
            __import__(module_path)
            print(f"âœ… {module_path} imported successfully")
            success_count += 1
    except ImportError as e:
        print(f"âŒ Failed to import {module_path}.{attribute}: {e}")
    except AttributeError as e:
        print(f"âŒ Attribute error in {module_path}.{attribute}: {e}")
    except Exception as e:
        print(f"âŒ Unexpected error with {module_path}.{attribute}: {e}")

print(f"\nğŸ“Š Import test results: {success_count}/{total_count} successful")

if success_count == total_count:
    print("ğŸ‰ All imports successful!")
    sys.exit(0)
else:
    print("âš ï¸ Some imports failed")
    sys.exit(1)
EOF
        )
        
        echo "$import_test_script" > test_imports.py
        python test_imports.py

    - name: Create simple main if needed
      run: |
        if [ ! -f "main.py" ] || [ ! -s "main.py" ]; then
          echo "ğŸ“ Creating simple main.py..."
          cat > main.py << 'EOF'
import time
import pandas as pd
import numpy as np
import sys
import os

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ù‡ sys.path
sys.path.insert(0, os.path.abspath(os.path.dirname(__file__)))

try:
    from services.coinex_api import CoinExAPI
    from services.telegram_bot import TelegramBot
    from strategies.mutanabby_strategy import MutanabbyStrategy
    from config.config import SYMBOLS, TIMEFRAME
    print("âœ… All modules imported successfully")
except ImportError as e:
    print(f"âŒ Import error: {e}")
    sys.exit(1)

def run_signal_check():
    print("ğŸš€ Starting Signal Bot...")
    
    coinex_api = CoinExAPI()
    telegram_bot = TelegramBot()
    strategy = MutanabbyStrategy()
    
    for symbol in SYMBOLS:
        try:
            print(f"ğŸ“Š Processing {symbol}...")
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±
            market_data = coinex_api.get_market_data(symbol, 'kline', 100, TIMEFRAME)
            
            if not market_data:
                print(f"âš ï¸ No data received for {symbol}")
                continue
            
            # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡
            df = pd.DataFrame(market_data, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
            df['timestamp'] = pd.to_datetime(df['timestamp'], unit='s')
            df.set_index('timestamp', inplace=True)
            
            for col in ['open', 'high', 'low', 'close', 'volume']:
                df[col] = pd.to_numeric(df[col])
            
            # ØªÙˆÙ„ÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„
            signals = strategy.generate_signals(df)
            
            print(f"ğŸ“ˆ Found {len(signals)} signals for {symbol}")
            
            # Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§
            for signal in signals:
                message = telegram_bot.format_signal_message(
                    symbol=symbol,
                    signal_type='BUY' if signal['type'] == 'BUY' else 'SELL',
                    entry=round(signal['entry'], 4),
                    sl=round(signal['sl'], 4),
                    tp1=round(signal['tp1'], 4),
                    tp2=round(signal['tp2'], 4),
                    tp3=round(signal['tp3'], 4)
                )
                
                if telegram_bot.send_message(message):
                    print(f"âœ… Signal sent for {symbol}")
                else:
                    print(f"âŒ Failed to send signal for {symbol}")
                
                time.sleep(1)
                
        except Exception as e:
            print(f"ğŸ’¥ Error processing {symbol}: {str(e)}")
            continue
    
    print("ğŸ¯ Signal check completed")

if __name__ == "__main__":
    run_signal_check()
EOF
          echo "âœ… simple main.py created"
        else
          echo "âœ… main.py already exists"
        fi

    - name: Run Signal Bot
      env:
        COINEX_ACCESS_ID: ${{ secrets.COINEX_ACCESS_ID }}
        COINEX_SECRET_KEY: ${{ secrets.COINEX_SECRET_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
        COMPREHENSIVE_TEST: ${{ github.event.inputs.comprehensive_test }}
      run: |
        echo "ğŸš€ Starting Signal Bot..."
        echo "ğŸ Debug Mode: $DEBUG_MODE"
        echo "ğŸ§ª Test Mode: $TEST_MODE"
        echo "ğŸ” Comprehensive Test: $COMPREHENSIVE_TEST"
        
        # ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§
        python -c "
import sys
import os
sys.path.insert(0, os.path.abspath('.'))
try:
    from main import run_signal_check
    print('âœ… Main module imported successfully')
except Exception as e:
    print(f'âŒ Failed to import main: {e}')
    sys.exit(1)
        "
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ
        if [ "$COMPREHENSIVE_TEST" = "true" ]; then
          echo "ğŸ” Running comprehensive test..."
          python -c "
import sys
import os
sys.path.insert(0, os.path.abspath('.'))
try:
    from services.debug_service import DebugService
    debug_service = DebugService()
    results = debug_service.run_comprehensive_test()
    print(f'Comprehensive test completed: {len(results)} symbols processed')
except Exception as e:
    print(f'Comprehensive test failed: {e}')
          "
        elif [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ Running in debug mode..."
          python main.py --debug --test
        elif [ "$TEST_MODE" = "true" ]; then
          echo "ğŸ§ª Running in test mode..."
          python main.py --test
        else
          echo "ğŸš€ Running in production mode..."
          python main.py
        fi

    - name: Upload logs and reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-results-${{ github.run_id }}
        path: |
          logs/
          debug/
        retention-days: 7

    - name: Send completion notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸ“¨ Sending completion notification..."
        python -c "
import requests
import os
telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')
if telegram_token and chat_id:
    message = 'ğŸ¤– Signal Bot execution completed\\nRun ID: ${{ github.run_id }}'
    url = f'https://api.telegram.org/bot{telegram_token}/sendMessage'
    payload = {'chat_id': chat_id, 'text': message}
    try:
        response = requests.post(url, json=payload, timeout=10)
        print('âœ… Notification sent')
    except Exception as e:
        print(f'âŒ Failed to send notification: {e}')
else:
    print('âš ï¸ Telegram credentials not available')
        "

  post-check:
    runs-on: ubuntu-latest
    needs: [check-structure, run-signal-bot]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download results
      uses: actions/download-artifact@v4
      with:
        name: bot-results-${{ github.run_id }}

    - name: Generate summary report
      run: |
        echo "ğŸ“Š Generating summary report..."
        echo "# Workflow Execution Summary" > summary.md
        echo "## Run ID: ${{ github.run_id }}" >> summary.md
        echo "## Status: ${{ job.status }}" >> summary.md
        echo "## Timestamp: $(date)" >> summary.md
        echo "" >> summary.md
        echo "### Artifacts Generated:" >> summary.md
        if [ -d "logs" ]; then
          echo "- âœ… Logs directory: $(find logs -type f | wc -l) files" >> summary.md
        else
          echo "- âŒ Logs directory: Missing" >> summary.md
        fi
        if [ -d "debug" ]; then
          echo "- âœ… Debug directory: $(find debug -type f | wc -l) files" >> summary.md
        else
          echo "- âŒ Debug directory: Missing" >> summary.md
        fi
        
        echo "" >> summary.md
        echo "### Project Structure Status:" >> summary.md
        echo "- Main.py: $(if [ -f "main.py" ]; then echo "âœ… Exists ($(wc -l < main.py) lines)"; else echo "âŒ Missing"; fi)" >> summary.md
        for dir in services strategies utils config; do
          echo "- $dir/: $(if [ -d "$dir" ]; then echo "âœ… Exists ($(find $dir -name '*.py' | wc -l) Python files)"; else echo "âŒ Missing"; fi)" >> summary.md
        done
        
        cat summary.md

    - name: Upload summary report
      uses: actions/upload-artifact@v4
      with:
        name: summary-report-${{ github.run_id }}
        path: summary.md
