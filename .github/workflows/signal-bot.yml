name: CoinEx Signal Bot

on:
  schedule:
    - cron: '*/15 * * * *'  # Ù‡Ø± 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      test_mode:
        description: 'Enable test mode (no signals sent)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-structure:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Analyze basic structure
      run: |
        echo "ðŸ” Analyzing project structure..."
        echo ""
        echo "ðŸ“ Current directory: $(pwd)"
        echo ""
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        echo "ðŸ“‚ Directory check:"
        directories=("services" "strategies" "utils" "config" "tests")
        for dir in "${directories[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir/"
            echo "   Files: $(ls -1 "$dir" 2>/dev/null | tr '\n' ' ' || echo 'None')"
          else
            echo "âŒ $dir/ (missing)"
          fi
        done
        echo ""

    - name: Check Python files
      run: |
        echo "ðŸ Python files check:"
        important_files=(
          "main.py"
          "config/config.py"
          "services/coinex_api.py"
          "services/telegram_bot.py"
          "strategies/mutanabby_strategy.py"
          "requirements.txt"
        )
        
        for file in "${important_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file (exists)"
          else
            echo "âŒ $file (missing)"
          fi
        done
        echo ""

    - name: Create missing directories
      run: |
        echo "ðŸ“ Creating necessary directories..."
        mkdir -p logs debug
        echo "âœ… Directories created: logs/, debug/"

    - name: Create __init__.py files
      run: |
        echo "ðŸ“¦ Ensuring __init__.py files..."
        for dir in services strategies utils config; do
          if [ -d "$dir" ] && [ ! -f "$dir/__init__.py" ]; then
            echo "# Package init" > "$dir/__init__.py"
            echo "âœ… Created $dir/__init__.py"
          elif [ -f "$dir/__init__.py" ]; then
            echo "âœ… $dir/__init__.py (exists)"
          fi
        done

  run-bot:
    runs-on: ubuntu-latest
    needs: check-structure
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        
        # Ù†ØµØ¨ dependencies Ø§Ø² requirements.txt ÛŒØ§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
          echo "âœ… Installed from requirements.txt"
        else
          pip install requests pandas numpy
          echo "âœ… Installed default packages"
        fi

    - name: Simple import test
      run: |
        echo "ðŸ Testing basic imports..."
        python -c "
try:
    import requests
    import pandas as pd
    import numpy as np
    print('âœ… Basic imports successful')
    
    # ØªØ³Øª Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
    import sys
    sys.path.insert(0, '.')
    
    try:
        from services.coinex_api import CoinExAPI
        print('âœ… CoinExAPI imported')
    except ImportError as e:
        print(f'âš ï¸ CoinExAPI import: {e}')
    
    try:
        from services.telegram_bot import TelegramBot
        print('âœ… TelegramBot imported')
    except ImportError as e:
        print(f'âš ï¸ TelegramBot import: {e}')
        
except Exception as e:
    print(f'âŒ Import failed: {e}')
        "

    - name: Create simple main if needed
      run: |
        if [ ! -f "main.py" ]; then
          echo "ðŸ“ Creating simple main.py..."
          cat > main.py << 'EOF'
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

print("ðŸ¤– Starting Simple Signal Bot")

try:
    from services.coinex_api import CoinExAPI
    from services.telegram_bot import TelegramBot
    from strategies.mutanabby_strategy import MutanabbyStrategy
    from config.config import SYMBOLS, TIMEFRAME
    
    print("âœ… All imports successful")
    
    # Ù†Ù…ÙˆÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§
    coinex_api = CoinExAPI()
    telegram_bot = TelegramBot()
    strategy = MutanabbyStrategy()
    
    print(f"ðŸ“Š Processing symbols: {SYMBOLS}")
    print("ðŸŽ¯ Bot is ready (simulation mode)")
    
except ImportError as e:
    print(f"âŒ Import error: {e}")
    print("Please check your project structure")
except Exception as e:
    print(f"ðŸ’¥ Unexpected error: {e}")

print("âœ… Bot setup completed")
EOF
          echo "âœ… Created main.py"
        else
          echo "âœ… main.py already exists"
        fi

    - name: Run the bot
      env:
        COINEX_ACCESS_ID: ${{ secrets.COINEX_ACCESS_ID }}
        COINEX_SECRET_KEY: ${{ secrets.COINEX_SECRET_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸš€ Running the bot..."
        python main.py

    - name: Create success flag
      run: |
        echo "âœ… Workflow completed successfully at $(date)" > success.txt
        echo "ðŸ“… Timestamp: $(date)" >> success.txt
        echo "ðŸ Python version: $(python --version)" >> success.txt

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: bot-results-${{ github.run_id }}
        path: |
          success.txt
          logs/
        retention-days: 3

  notify:
    runs-on: ubuntu-latest
    needs: run-bot
    if: always()
    
    steps:
    - name: Send notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸ“¨ Sending notification..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ† Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„é€šçŸ¥
        cat > send_notification.py << 'EOF'
import os
import requests

def send_telegram_message():
    token = os.getenv('TELEGRAM_BOT_TOKEN')
    chat_id = os.getenv('TELEGRAM_CHAT_ID')
    
    if not token or not chat_id:
        print("âŒ Telegram credentials missing")
        return False
    
    message = "ðŸ¤– Signal Bot Execution Completed\nâœ… Workflow finished successfully"
    
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    payload = {
        'chat_id': chat_id,
        'text': message
    }
    
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            print("âœ… Notification sent")
            return True
        else:
            print(f"âŒ Failed to send: {response.text}")
            return False
    except Exception as e:
        print(f"âŒ Error sending: {e}")
        return False

if __name__ == "__main__":
    send_telegram_message()
EOF
        
        python send_notification.py
