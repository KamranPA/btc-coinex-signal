name: CoinEx Signal Bot - Production

on:
  schedule:
    - cron: '*/15 * * * *'  # هر 15 دقیقه اجرا شود
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no real signals)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  run-signal-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests python-dotenv ta-lib

    - name: Create production main.py
      run: |
        echo "=== Creating Production Main.py ==="
        
        echo "#!/usr/bin/env python3" > main.py
        echo "import json" >> main.py
        echo "import os" >> main.py
        echo "import sys" >> main.py
        echo "import logging" >> main.py
        echo "from datetime import datetime" >> main.py
        echo "" >> main.py
        echo "# Setup logging" >> main.py
        echo "logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')" >> main.py
        echo "logger = logging.getLogger(__name__)" >> main.py
        echo "" >> main.py
        echo "def main():" >> main.py
        echo "    try:" >> main.py
        echo "        logger.info(f\"💰 Signal Bot started at {datetime.now()}\")" >> main.py
        echo "" >> main.py
        echo "        # Import components" >> main.py
        echo "        from services.coinex_api import CoinExAPI" >> main.py
        echo "        from services.telegram_bot import TelegramBot" >> main.py
        echo "        from strategy_executor import execute_strategy" >> main.py
        echo "" >> main.py
        echo "        api = CoinExAPI()" >> main.py
        echo "        telegram_bot = TelegramBot()" >> main.py
        echo "" >> main.py
        echo "        logger.info(\"✅ Components imported\")" >> main.py
        echo "" >> main.py
        echo "        # Execute strategy" >> main.py
        echo "        logger.info(\"🔍 Analyzing multiple symbols...\")" >> main.py
        echo "        signals = execute_strategy()" >> main.py
        echo "" >> main.py
        echo "        if signals and len(signals) > 0:" >> main.py
        echo "            logger.info(f\"🎯 Found {len(signals)} total signals\")" >> main.py
        echo "            " >> main.py
        echo "            # Send signals via Telegram" >> main.py
        echo "            if '--test' not in sys.argv:" >> main.py
        echo "                telegram_methods = ['send_signals', 'send_message', 'send_signal', 'notify']" >> main.py
        echo "                sent = False" >> main.py
        echo "                for method_name in telegram_methods:" >> main.py
        echo "                    if hasattr(telegram_bot, method_name):" >> main.py
        echo "                        try:" >> main.py
        echo "                            method = getattr(telegram_bot, method_name)" >> main.py
        echo "                            method(signals)" >> main.py
        echo "                            logger.info(f\"📤 Signals sent via {method_name}\")" >> main.py
        echo "                            sent = True" >> main.py
        echo "                            break" >> main.py
        echo "                        except Exception as e:" >> main.py
        echo "                            logger.warning(f\"⚠ Telegram method {method_name} failed: {e}\")" >> main.py
        echo "                " >> main.py
        echo "                if not sent:" >> main.py
        echo "                    logger.error(\"❌ No working Telegram method found\")" >> main.py
        echo "            else:" >> main.py
        echo "                logger.info(\"🧪 Test mode - Signals not sent\")" >> main.py
        echo "                for signal in signals:" >> main.py
        echo "                    logger.info(f\"TEST SIGNAL: {signal}\")" >> main.py
        echo "        else:" >> main.py
        echo "            logger.info(\"📭 No signals found\")" >> main.py
        echo "" >> main.py
        echo "        return True" >> main.py
        echo "" >> main.py
        echo "    except Exception as e:" >> main.py
        echo "        logger.error(f\"❌ Error in main execution: {e}\")" >> main.py
        echo "        import traceback" >> main.py
        echo "        logger.error(traceback.format_exc())" >> main.py
        echo "        return False" >> main.py
        echo "" >> main.py
        echo "if __name__ == \"__main__\":" >> main.py
        echo "    success = main()" >> main.py
        echo "    sys.exit(0 if success else 1)" >> main.py

        echo "Production main.py created successfully"

    - name: Create strategy executor
      run: |
        echo "=== Creating Strategy Executor ==="
        
        echo "#!/usr/bin/env python3" > strategy_executor.py
        echo "import json" >> strategy_executor.py
        echo "import logging" >> strategy_executor.py
        echo "from datetime import datetime" >> strategy_executor.py
        echo "logging.basicConfig(level=logging.INFO)" >> strategy_executor.py
        echo "logger = logging.getLogger(__name__)" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "def execute_strategy():" >> strategy_executor.py
        echo "    try:" >> strategy_executor.py
        echo "        from services.coinex_api import CoinExAPI" >> strategy_executor.py
        echo "        from strategies.mutanabby_strategy import MutanabbyStrategy" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "        api = CoinExAPI()" >> strategy_executor.py
        echo "        " >> strategy_executor.py
        echo "        # Initialize strategy" >> strategy_executor.py
        echo "        try:" >> strategy_executor.py
        echo "            strategy = MutanabbyStrategy(api)" >> strategy_executor.py
        echo "        except TypeError:" >> strategy_executor.py
        echo "            strategy = MutanabbyStrategy()" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "        # Get market data" >> strategy_executor.py
        echo "        symbols = ['BTCUSDT', 'ETHUSDT', 'ADAUSDT', 'XRPUSDT']" >> strategy_executor.py
        echo "        all_signals = []" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "        for symbol in symbols:" >> strategy_executor.py
        echo "            try:" >> strategy_executor.py
        echo "                logger.info(f\"Analyzing {symbol}...\")" >> strategy_executor.py
        echo "                market_data = api.get_market_data(symbol)" >> strategy_executor.py
        echo "                " >> strategy_executor.py
        echo "                if isinstance(market_data, list) and len(market_data) > 0:" >> strategy_executor.py
        echo "                    # Assuming each item in list is a candle/stick data" >> strategy_executor.py
        echo "                    # Pass the entire list or last few items to strategy" >> strategy_executor.py
        echo "                    recent_data = market_data[-50:]  # last 50 candles" >> strategy_executor.py
        echo "                    " >> strategy_executor.py
        echo "                    if hasattr(strategy, 'generate_signals'):" >> strategy_executor.py
        echo "                        try:" >> strategy_executor.py
        echo "                            signals = strategy.generate_signals(recent_data)" >> strategy_executor.py
        echo "                            if signals:" >> strategy_executor.py
        echo "                                for signal in signals:" >> strategy_executor.py
        echo "                                    signal['symbol'] = symbol  # Add symbol to signal" >> strategy_executor.py
        echo "                                    signal['timestamp'] = datetime.now().isoformat()" >> strategy_executor.py
        echo "                                all_signals.extend(signals)" >> strategy_executor.py
        echo "                                logger.info(f\"Found {len(signals)} signals for {symbol}\")" >> strategy_executor.py
        echo "                            else:" >> strategy_executor.py
        echo "                                logger.info(f\"No signals for {symbol}\")" >> strategy_executor.py
        echo "                        except Exception as e:" >> strategy_executor.py
        echo "                            logger.warning(f\"generate_signals failed for {symbol}: {e}\")" >> strategy_executor.py
        echo "                    else:" >> strategy_executor.py
        echo "                        logger.warning(f\"No generate_signals method for {symbol}\")" >> strategy_executor.py
        echo "                else:" >> strategy_executor.py
        echo "                    logger.warning(f\"No market data for {symbol}\")" >> strategy_executor.py
        echo "                    " >> strategy_executor.py
        echo "            except Exception as e:" >> strategy_executor.py
        echo "                logger.error(f\"Error processing {symbol}: {e}\")" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "        return all_signals" >> strategy_executor.py
        echo "    " >> strategy_executor.py
        echo "    except Exception as e:" >> strategy_executor.py
        echo "        logger.error(f\"Error in strategy executor: {e}\")" >> strategy_executor.py
        echo "        import traceback" >> strategy_executor.py
        echo "        logger.error(traceback.format_exc())" >> strategy_executor.py
        echo "        return []" >> strategy_executor.py
        echo "" >> strategy_executor.py
        echo "if __name__ == \"__main__\":" >> strategy_executor.py
        echo "    signals = execute_strategy()" >> strategy_executor.py
        echo "    print(f\"Total signals found: {len(signals)}\")" >> strategy_executor.py
        echo "    for signal in signals:" >> strategy_executor.py
        echo "        print(f\"Signal: {signal}\")" >> strategy_executor.py
        
        echo "Strategy executor created successfully"

    - name: Run Signal Bot
      env:
        COINEX_ACCESS_ID: ${{ secrets.COINEX_ACCESS_ID }}
        COINEX_SECRET_KEY: ${{ secrets.COINEX_SECRET_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        echo "=== Starting Signal Bot ==="
        echo "Telegram Token: ${TELEGRAM_BOT_TOKEN:0:10}..."
        echo "Telegram Chat ID: $TELEGRAM_CHAT_ID"
        echo "Test Mode: $TEST_MODE"
        
        if [ "$TEST_MODE" = "true" ]; then
            echo "🟡 Running in TEST mode"
            python main.py --test
        else
            echo "🟢 Running in PRODUCTION mode"
            python main.py
        fi

    - name: Send completion notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
      run: |
        echo "=== Sending Completion Notification ==="
        
        mkdir -p .github/scripts
        
        echo "import requests" > .github/scripts/notify.py
        echo "import os" >> .github/scripts/notify.py
        echo "from datetime import datetime" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "def send_notification():" >> .github/scripts/notify.py
        echo "    token = os.getenv('TELEGRAM_BOT_TOKEN')" >> .github/scripts/notify.py
        echo "    chat_id = os.getenv('TELEGRAM_CHAT_ID')" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    if not token or not chat_id:" >> .github/scripts/notify.py
        echo "        print('Telegram credentials missing')" >> .github/scripts/notify.py
        echo "        return False" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    workflow = os.getenv('GITHUB_WORKFLOW', 'Unknown')" >> .github/scripts/notify.py
        echo "    run_id = os.getenv('GITHUB_RUN_ID', 'Unknown')" >> .github/scripts/notify.py
        echo "    repo = os.getenv('GITHUB_REPOSITORY', 'Unknown')" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    status = 'Success'" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    message = f\"\"\"" >> .github/scripts/notify.py
        echo "🤖 <b>Signal Bot Execution Completed</b>" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "📊 <b>Workflow:</b> {workflow}" >> .github/scripts/notify.py
        echo "🏷️ <b>Run ID:</b> #{run_id}" >> .github/scripts/notify.py
        echo "📁 <b>Repository:</b> {repo}" >> .github/scripts/notify.py
        echo "⏰ <b>Time:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}" >> .github/scripts/notify.py
        echo "✅ <b>Status:</b> {status}" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "🔗 <a href=\\\"https://github.com/{repo}/actions/runs/{run_id}\\\">View Details</a>" >> .github/scripts/notify.py
        echo "    \"\"\"" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    url = f\"https://api.telegram.org/bot{token}/sendMessage\"" >> .github/scripts/notify.py
        echo "    payload = {" >> .github/scripts/notify.py
        echo "        'chat_id': chat_id," >> .github/scripts/notify.py
        echo "        'text': message," >> .github/scripts/notify.py
        echo "        'parse_mode': 'HTML'," >> .github/scripts/notify.py
        echo "        'disable_web_page_preview': True" >> .github/scripts/notify.py
        echo "    }" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "    try:" >> .github/scripts/notify.py
        echo "        response = requests.post(url, json=payload, timeout=10)" >> .github/scripts/notify.py
        echo "        return response.status_code == 200" >> .github/scripts/notify.py
        echo "    except Exception:" >> .github/scripts/notify.py
        echo "        return False" >> .github/scripts/notify.py
        echo "" >> .github/scripts/notify.py
        echo "if __name__ == \"__main__\":" >> .github/scripts/notify.py
        echo "    send_notification()" >> .github/scripts/notify.py
        
        python .github/scripts/notify.py

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Final cleanup
      run: |
        echo "🤖 Signal Bot workflow completed"
        echo "⏰ Time: $(date)"
        echo "🆔 Run ID: ${{ github.run_id }}"
