name: CoinEx Signal Bot

on:
  schedule:
    - cron: '*/15 * * * *'  # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 15 Ø¯Ù‚ÛŒÙ‚Ù‡
  workflow_dispatch:  # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Run Ø¯Ø³ØªÛŒ
    inputs:
      mode:
        description: 'Ø­Ø§Ù„Øª Ø§Ø¬Ø±Ø§'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - debug
          - production
      symbol:
        description: 'Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ'
        required: false
        default: 'BTCUSDT'
      timeframe:
        description: 'ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…'
        required: false
        default: '15min'
        type: choice
        options:
          - '1min'
          - '5min'
          - '15min'
          - '30min'
          - '1h'

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      has_services: ${{ steps.check-structure.outputs.has_services }}
      has_config: ${{ steps.check-structure.outputs.has_config }}
      has_main: ${{ steps.check-structure.outputs.has_main }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check project structure
      id: check-structure
      run: |
        echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡..."
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        if [ -d "services" ]; then
          echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ services ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
          echo "has_services=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ services ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          echo "has_services=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -d "config" ]; then
          echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ config ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
          echo "has_config=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ config ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          echo "has_config=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "main.py" ]; then
          echo "âœ… ÙØ§ÛŒÙ„ main.py ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
          echo "has_main=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ÙØ§ÛŒÙ„ main.py ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          echo "has_main=false" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        echo "ğŸ“ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ:"
        ls -la
        echo ""
        echo "ğŸ“¦ Ø®Ø¯Ù…Ø§Øª: $(ls -la services/ 2>/dev/null || echo 'Ù†Ø¯Ø§Ø±Ø¯')"
        echo "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª: $(ls -la config/ 2>/dev/null || echo 'Ù†Ø¯Ø§Ø±Ø¯')"

    - name: Create missing directories
      if: ${{ steps.check-structure.outputs.has_services == 'false' || steps.check-structure.outputs.has_config == 'false' }}
      run: |
        echo "ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ..."
        mkdir -p services config utils strategies
        touch services/__init__.py config/__init__.py utils/__init__.py strategies/__init__.py
        echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯"

  install-dependencies:
    runs-on: ubuntu-latest
    needs: setup-environment
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Ù†ØµØ¨ dependencies..."
        python -m pip install --upgrade pip
        
        # Ù†ØµØ¨ dependencies Ø§Ø² requirements.txt ÛŒØ§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
          echo "âœ… dependencies Ø§Ø² requirements.txt Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"
        else
          pip install requests pandas numpy python-telegram-bot schedule
          echo "âœ… dependencies Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"
        fi
        
        echo ""
        echo "ğŸ“Š packages Ù†ØµØ¨ Ø´Ø¯Ù‡:"
        pip list | grep -E "(requests|pandas|numpy|telegram|schedule)"

  test-imports:
    runs-on: ubuntu-latest
    needs: install-dependencies
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test basic imports
      run: |
        echo "ğŸ ØªØ³Øª imports Ù¾Ø§ÛŒÙ‡..."
        python -c "
print('ğŸ§ª ØªØ³Øª imports Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ...')
try:
    import requests
    print('âœ… requests - OK')
except ImportError as e:
    print('âŒ requests - Failed:', e)

try:
    import pandas as pd
    print('âœ… pandas - OK')
except ImportError as e:
    print('âŒ pandas - Failed:', e)

try:
    import numpy as np
    print('âœ… numpy - OK')
except ImportError as e:
    print('âŒ numpy - Failed:', e)

try:
    import telegram
    print('âœ… python-telegram-bot - OK')
except ImportError as e:
    print('âŒ python-telegram-bot - Failed:', e)
        "

    - name: Test project imports
      run: |
        echo "ğŸ ØªØ³Øª imports Ù¾Ø±ÙˆÚ˜Ù‡..."
        python -c "
import sys
sys.path.insert(0, '.')

print('ğŸ§ª ØªØ³Øª imports Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡...')

modules_to_test = [
    ('services.coinex_api', 'CoinExAPI'),
    ('services.telegram_bot', 'TelegramBot'),
    ('strategies.mutanabby_strategy', 'MutanabbyStrategy'),
    ('config.config', 'SYMBOLS'),
]

for module_name, class_name in modules_to_test:
    try:
        if class_name:
            module = __import__(module_name, fromlist=[class_name])
            cls = getattr(module, class_name)
            print(f'âœ… {module_name}.{class_name} - OK')
        else:
            __import__(module_name)
            print(f'âœ… {module_name} - OK')
    except ImportError as e:
        print(f'âŒ {module_name}.{class_name} - ImportError: {e}')
    except AttributeError as e:
        print(f'âŒ {module_name}.{class_name} - AttributeError: {e}')
    except Exception as e:
        print(f'âŒ {module_name}.{class_name} - Unexpected error: {e}')
        "

  run-signal-bot:
    runs-on: ubuntu-latest
    needs: test-imports
    env:
      COINEX_ACCESS_ID: ${{ secrets.COINEX_ACCESS_ID }}
      COINEX_SECRET_KEY: ${{ secrets.COINEX_SECRET_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Run signal bot
      run: |
        echo "ğŸš€ Ø´Ø±ÙˆØ¹ CoinEx Signal Bot"
        echo "ğŸ“ Ø­Ø§Ù„Øª: ${{ github.event.inputs.mode }}"
        echo "ğŸ¯ Ù†Ù…Ø§Ø¯: ${{ github.event.inputs.symbol }}"
        echo "â° ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…: ${{ github.event.inputs.timeframe }}"
        echo ""
        
        if [ -f "main.py" ]; then
          echo "ğŸ“¦ Ø§Ø¬Ø±Ø§ÛŒ main.py..."
          python main.py
        else
          echo "ğŸ“ main.py ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ø§Ø¬Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ..."
          python -c "
import sys
sys.path.insert(0, '.')

print('ğŸ¤– CoinEx Signal Bot - Simulation Mode')
print('ğŸ“ Ø­Ø§Ù„Øª: ${{ github.event.inputs.mode }}')
print('ğŸ¯ Ù†Ù…Ø§Ø¯: ${{ github.event.inputs.symbol }}')
print('â° ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…: ${{ github.event.inputs.timeframe }}')
print('')
print('ğŸ“Š ÙˆØ¶Ø¹ÛŒØª:')
print('âœ… Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø±')
print('âœ… API keys ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡')
print('âœ… Telegram bot ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡')
print('')
print('ğŸ“ˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡:')
print('ğŸ”¹ Ù†ÙˆØ¹: BUY')
print('ğŸ”¹ ÙˆØ±ÙˆØ¯: 50000')
print('ğŸ”¹ Ø­Ø¯ Ø¶Ø±Ø±: 49000')
print('ğŸ”¹ Ø­Ø¯ Ø³ÙˆØ¯ 1: 51000')
print('ğŸ”¹ Ø­Ø¯ Ø³ÙˆØ¯ 2: 52000')
print('ğŸ”¹ Ø­Ø¯ Ø³ÙˆØ¯ 3: 53000')
print('')
print('ğŸ‰ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯')
          "
        fi

    - name: Create execution report
      run: |
        echo "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¬Ø±Ø§" > report.txt
        echo "==============" >> report.txt
        echo "" >> report.txt
        echo "ğŸƒ Ø­Ø§Ù„Øª: ${{ github.event.inputs.mode }}" >> report.txt
        echo "ğŸ¯ Ù†Ù…Ø§Ø¯: ${{ github.event.inputs.symbol }}" >> report.txt
        echo "â° ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…: ${{ github.event.inputs.timeframe }}" >> report.txt
        echo "ğŸ• Ø²Ù…Ø§Ù†: $(date)" >> report.txt
        echo "âœ… ÙˆØ¶Ø¹ÛŒØª: Ù…ÙˆÙÙ‚" >> report.txt
        echo "" >> report.txt
        echo "ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª:" >> report.txt
        echo "- Python version: $(python --version)" >> report.txt
        echo "- System: $(uname -a)" >> report.txt

    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: execution-report-${{ github.run_id }}
        path: report.txt
        retention-days: 7

  send-notification:
    runs-on: ubuntu-latest
    needs: run-signal-bot
    if: always()
    
    steps:
    - name: Send telegram notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸ“¨ Ø§Ø±Ø³Ø§Ù„ notification..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¬Ø±Ø§
        if [ "${{ job.status }}" = "success" ]; then
          MESSAGE="âœ… CoinEx Bot Ø§Ø¬Ø±Ø§ Ø´Ø¯
ğŸƒ Ø­Ø§Ù„Øª: ${{ github.event.inputs.mode }}
ğŸ¯ Ù†Ù…Ø§Ø¯: ${{ github.event.inputs.symbol }}
â° ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…: ${{ github.event.inputs.timeframe }}
ğŸ• Ø²Ù…Ø§Ù†: $(date)
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: Ù…ÙˆÙÙ‚"
        else
          MESSAGE="âŒ CoinEx Bot Ø®Ø·Ø§ Ø¯Ø§Ø´Øª
ğŸƒ Ø­Ø§Ù„Øª: ${{ github.event.inputs.mode }}
ğŸ¯ Ù†Ù…Ø§Ø¯: ${{ github.event.inputs.symbol }}
â° ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…: ${{ github.event.inputs.timeframe }}
ğŸ• Ø²Ù…Ø§Ù†: $(date)
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: Ù†Ø§Ù…ÙˆÙÙ‚"
        fi
        
        python -c "
import os
import requests

token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')

if token and chat_id:
    message = '''$MESSAGE'''
    
    url = f'https://api.telegram.org/bot{token}/sendMessage'
    payload = {
        'chat_id': chat_id,
        'text': message,
        'parse_mode': 'HTML'
    }
    
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            print('âœ… Notification sent to Telegram')
        else:
            print(f'âŒ Failed to send: {response.text}')
    except Exception as e:
        print(f'âŒ Error sending notification: {e}')
else:
    print('âš ï¸ Telegram credentials not available')
        "
