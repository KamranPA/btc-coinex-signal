name: 📊 اجرای بک‌تست تاریخی

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'تاریخ شروع (YYYY-MM-DD)'
        type: string
        default: '2023-01-01'
        required: true
      end_date:
        description: 'تاریخ پایان (YYYY-MM-DD)'
        type: string
        default: '2023-12-31'
        required: true

jobs:
  backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: 🔁 دریافت کد
      uses: actions/checkout@v4

    - name: 🐍 تنظیم پایتون 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 📦 نصب کتابخانه‌ها
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 📁 ایجاد پوشه‌های ضروری
      run: |
        mkdir -p logs
        mkdir -p results
        mkdir -p src/logs
        mkdir -p src/results

    - name: ▶️ اجرای بک‌تست
      run: |
        cd src && python main.py \
          --mode backtest \
          --start ${{ inputs.start_date }} \
          --end ${{ inputs.end_date }}

    - name: 📎 آپلود نتایج بک‌تست
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-results
        path: results/
        retention-days: 7

    - name: 📎 آپلود لاگ‌ها
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-logs
        path: logs/
        retention-days: 7
