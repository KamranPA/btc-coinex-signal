name: ๐ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช ุฒูุฏู

on:
  # ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ูุฑ 15 ุฏููู ุงุฒ ุณุงุนุช 03:00 ุชุง 20:30 UTC (06:30 ุชุง 23:30 ุจู ููุช ุงุฑุงู)
  schedule:
    - cron: '*/15 3-20 * * *'

  # ุงูฺฉุงู ุงุฌุฑุง ุฏุณุช ุงุฒ ุทุฑู GitHub
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ุงุฌุฑุง ุฎุงุฑุฌ ุงุฒ ุณุงุนุงุช ุจุงุฒุงุฑุ'
        type: boolean
        default: false
        required: false

jobs:
  run-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    # 1๏ธโฃ ุฏุฑุงูุช ฺฉุฏ ุงุฒ ุฑูพุงุฒุชูุฑ
    - name: ๐ ุฏุฑุงูุช ฺฉุฏ (Checkout)
      uses: actions/checkout@v4

    # 2๏ธโฃ ุชูุธู ูุณุฎู ูพุงุชูู 3.9
    - name: ๐ ุชูุธู ูพุงุชูู 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3๏ธโฃ ูุตุจ ูุงุจุณุชฺฏโูุง ุณุณุชู ู ฺฉุงููพุงู TA-Lib
    - name: โ๏ธ ูุตุจ ู ฺฉุงููพุงู TA-Lib ุงุฒ ุณูุฑุณ
      run: |
        echo "๐ ุจูโุฑูุฒุฑุณุงู ูุณุช ุจุณุชูโูุง..."
        sudo apt-get update -y

        echo "๐ฆ ูุตุจ ูพุดโูุงุฒูุง ุณุณุชู..."
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          wget \
          libtool \
          automake \
          g++ \
          make

        echo "โฌ๏ธ ุฏุงูููุฏ TA-Lib 0.4.0..."
        wget https://downloads.sourceforge.net/project/ta-lib/ta-lib/0.4.0/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/

        echo "๐ง ูพฺฉุฑุจูุฏ TA-Lib..."
        ./configure --prefix=/usr

        echo "๐จ ฺฉุงููพุงู TA-Lib..."
        make -j$(nproc)

        echo "โ ูุตุจ TA-Lib ุฏุฑ ุณุณุชู..."
        sudo make install

        echo "๐งน ูพุงฺฉโุณุงุฒ ูุงูโูุง ูููุช..."
        cd ..
        rm -rf ta-lib-0.4.0-src.tar.gz ta-lib

        echo "๐ ุจุงุฑฺฏุฑ ูุฌุฏุฏ ฺฉุชุงุจุฎุงููโูุง ุณุณุชู..."
        sudo ldconfig

        echo "๐ ูุตุจ TA-Lib ุจุง ููููุช ุงูุฌุงู ุดุฏ!"

    # 4๏ธโฃ ุจุฑุฑุณ ูุตุจ ููููุชโุขูุฒ TA-Lib
    - name: ๐งช ุจุฑุฑุณ ูุตุจ TA-Lib
      run: |
        python -c "
        try:
            import talib
            print(f'โ TA-Lib ุจุง ููููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ. ูุณุฎู: {talib.__version__}')
        except ImportError as e:
            print(f'โ ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ TA-Lib: {e}')
            exit(1)
        "

    # 5๏ธโฃ ูุตุจ ฺฉุชุงุจุฎุงููโูุง ูพุงุชูู
    - name: ๐ฆ ูุตุจ ฺฉุชุงุจุฎุงููโูุง ูพุงุชูู
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install -r requirements.txt

    # 6๏ธโฃ ุงุฌุงุฏ ูพูุดูโูุง ุถุฑูุฑ
    - name: ๐ ุงุฌุงุฏ ูพูุดูโูุง ูุงฺฏ ู ูุชุงุฌ
      run: |
        mkdir -p logs
        mkdir -p results
        mkdir -p src/logs
        mkdir -p src/results
        touch logs/trading.log
        echo "โ ูพูุดูโูุง ุจุง ููููุช ุงุฌุงุฏ ุดุฏูุฏ."

    # 7๏ธโฃ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช
    - name: โถ๏ธ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช (ุญุงูุช ุฒูุฏู)
      run: |
        cd src && python main.py --mode live

    # 8๏ธโฃ ุขูพููุฏ ูุงฺฏโูุง ุจุฑุง ุฏุจุงฺฏ (ุฏุฑ ูุฑ ุตูุฑุช)
    - name: ๐ ุขูพููุฏ ูุงฺฏโูุง
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-logs
        path: logs/
        retention-days: 3
