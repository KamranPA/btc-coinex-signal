#!/usr/bin/env python3
import os
import time
import argparse
from datetime import datetime, time, timedelta
from exchange_connector import ExchangeConnector
from strategy_engine import InstitutionalStrategy
from trade_logger import TradeLogger
from telegram_bot import send_signal
import config

class TradeExecutor:
    def __init__(self):
        self.connector = ExchangeConnector()
        self.strategy = InstitutionalStrategy()
        self.logger = TradeLogger()
        self.last_check = None

    def is_market_active(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± Ø³Ø§Ø¹Ø§Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª (03:00 ØªØ§ 20:30 UTC)"""
        now = datetime.utcnow()
        return time(3, 0) <= now.time() <= time(20, 30)

    def time_until_market_open(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø¨Ø§Ø² Ø´Ø¯Ù† Ø¨Ø§Ø²Ø§Ø±"""
        now = datetime.utcnow()
        if now.time() > time(20, 30):
            next_open = (now + timedelta(days=1)).replace(hour=3, minute=0, second=0)
        else:
            next_open = now.replace(hour=3, minute=0, second=0)
        return (next_open - now).total_seconds()

    def execute_trade_check(self, force=False):
        """Ø§Ø¬Ø±Ø§ÛŒ ÛŒÚ© Ú†Ø±Ø®Ù‡ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù…Ø¹Ø§Ù…Ù„Ù‡"""
        try:
            current_time = datetime.utcnow()
            
            if not force and not self.is_market_active():
                print(f"â³ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª. Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¯Ø± {self.time_until_market_open()/60:.1f} Ø¯Ù‚ÛŒÙ‚Ù‡")
                return False

            print(f"\n{'='*40}")
            print(f"ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± {current_time.strftime('%Y-%m-%d %H:%M:%S')} UTC")
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±
            market_data = self.connector.fetch_data(
                symbol=config.SYMBOL,
                interval=config.TIMEFRAME,
                limit=100
            )
            
            # ØªØ­Ù„ÛŒÙ„ Ùˆ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
            analyzed_data = self.strategy.calculate(market_data)
            latest_signal = analyzed_data.iloc[-1]
            
            if latest_signal['signal'] == 1:
                trade_details = {
                    'symbol': config.SYMBOL,
                    'entry': latest_signal['close'],
                    'sl': latest_signal['stop_loss'],
                    'tp': latest_signal['take_profit'],
                    'timestamp': latest_signal['timestamp'].strftime('%Y-%m-%d %H:%M:%S')
                }
                
                # Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„
                self.logger.log_trade(trade_details)
                send_signal(trade_details)
                print(f"ğŸš€ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯!")
                print(f"â€¢ Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯: {trade_details['entry']:.2f}")
                print(f"â€¢ Ø­Ø¯ Ø¶Ø±Ø±: {trade_details['sl']:.2f}")
                print(f"â€¢ Ø­Ø¯ Ø³ÙˆØ¯: {trade_details['tp']:.2f}")
                return True
            
            print("ğŸ” Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯")
            return False
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡: {str(e)}")
            return False

    def run_continuous(self, interval=900):
        """Ø­Ø§Ù„Øª Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒÙˆØ³ØªÙ‡"""
        print("ğŸ”„ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±")
        print(f"â° ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø±Ø³ÛŒ: Ù‡Ø± {interval//60} Ø¯Ù‚ÛŒÙ‚Ù‡")
        
        while True:
            if self.is_market_active():
                self.execute_trade_check()
            else:
                sleep_time = self.time_until_market_open()
                print(f"ğŸ’¤ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª. Ø®ÙˆØ§Ø¨ Ø¨Ù‡ Ù…Ø¯Øª {sleep_time/3600:.1f} Ø³Ø§Ø¹Øª")
                time.sleep(sleep_time)
            
            time.sleep(interval)

    def run_manual(self, force=False):
        """Ø­Ø§Ù„Øª Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ"""
        print("\nğŸ–±ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø³ÛŒØ³ØªÙ… Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ")
        if force or self.is_market_active():
            print("ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø±...")
            result = self.execute_trade_check(force=True)
            print("\nâœ… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯" if result else "\nğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯")
        else:
            print("âš ï¸ ØªÙˆØ¬Ù‡: Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª")
            if input("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯ØŸ (y/n): ").lower() == 'y':
                self.execute_trade_check(force=True)

def main():
    parser = argparse.ArgumentParser(
        description='Ø³ÛŒØ³ØªÙ… Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„',
        formatter_class=argparse.RawTextHelpFormatter,
        epilog="""
Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡:
  Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø±:    python run_trade.py --auto
  Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ:     python run_trade.py
  Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ:   python run_trade.py --force
"""
    )
    parser.add_argument('--auto', action='store_true', help='Ø­Ø§Ù„Øª Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±')
    parser.add_argument('--force', action='store_true', help='Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø±')
    parser.add_argument('--interval', type=int, default=900, 
                      help='ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ø«Ø§Ù†ÛŒÙ‡ØŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 900 (15 Ø¯Ù‚ÛŒÙ‚Ù‡))')
    
    args = parser.parse_args()
    
    trader = TradeExecutor()
    
    try:
        if args.auto:
            trader.run_continuous(interval=args.interval)
        else:
            trader.run_manual(force=args.force)
    except KeyboardInterrupt:
        print("\nğŸ›‘ Ø³ÛŒØ³ØªÙ… ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {str(e)}")

if __name__ == "__main__":
    main()
