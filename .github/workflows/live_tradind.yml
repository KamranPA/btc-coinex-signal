name: 🚀 اجرای سیستم معاملاتی زنده

on:
  # اجرای خودکار هر 15 دقیقه از ساعت 03:00 تا 20:30 UTC (06:30 تا 23:30 به وقت ایران)
  schedule:
    - cron: '*/15 3-20 * * *'

  # امکان اجرای دستی از طریق GitHub
  workflow_dispatch:
    inputs:
      force_run:
        description: 'اجرا خارج از ساعات بازار؟'
        type: boolean
        default: false
        required: false

jobs:
  run-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    # 1️⃣ دریافت کد از ریپازیتوری
    - name: 🔁 دریافت کد (Checkout)
      uses: actions/checkout@v4

    # 2️⃣ تنظیم نسخه پایتون 3.9
    - name: 🐍 تنظیم پایتون 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3️⃣ نصب وابستگی‌های سیستمی و کامپایل TA-Lib
    - name: ⚙️ نصب و کامپایل TA-Lib از سورس
      run: |
        echo "🔄 به‌روزرسانی لیست بسته‌ها..."
        sudo apt-get update -y

        echo "📦 نصب پیش‌نیازهای سیستمی..."
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          wget \
          libtool \
          automake \
          g++ \
          make

        echo "⬇️ دانلود TA-Lib 0.4.0..."
        wget https://downloads.sourceforge.net/project/ta-lib/ta-lib/0.4.0/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/

        echo "🔧 پیکربندی TA-Lib..."
        ./configure --prefix=/usr

        echo "🔨 کامپایل TA-Lib..."
        make -j$(nproc)

        echo "✅ نصب TA-Lib در سیستم..."
        sudo make install

        echo "🧹 پاک‌سازی فایل‌های موقت..."
        cd ..
        rm -rf ta-lib-0.4.0-src.tar.gz ta-lib

        echo "🔄 بارگیری مجدد کتابخانه‌های سیستم..."
        sudo ldconfig

        echo "🎉 نصب TA-Lib با موفقیت انجام شد!"

    # 4️⃣ بررسی نصب موفقیت‌آمیز TA-Lib
    - name: 🧪 بررسی نصب TA-Lib
      run: |
        python -c "
        try:
            import talib
            print(f'✅ TA-Lib با موفقیت بارگذاری شد. نسخه: {talib.__version__}')
        except ImportError as e:
            print(f'❌ خطا در بارگذاری TA-Lib: {e}')
            exit(1)
        "

    # 5️⃣ نصب کتابخانه‌های پایتون
    - name: 📦 نصب کتابخانه‌های پایتون
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install -r requirements.txt

    # 6️⃣ ایجاد پوشه‌های ضروری
    - name: 📁 ایجاد پوشه‌های لاگ و نتایج
      run: |
        mkdir -p logs
        mkdir -p results
        mkdir -p src/logs
        mkdir -p src/results
        touch logs/trading.log
        echo "✅ پوشه‌ها با موفقیت ایجاد شدند."

    # 7️⃣ اجرای سیستم معاملاتی
    - name: ▶️ اجرای سیستم معاملاتی (حالت زنده)
      run: |
        cd src && python main.py --mode live

    # 8️⃣ آپلود لاگ‌ها برای دیباگ (در هر صورت)
    - name: 📎 آپلود لاگ‌ها
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-logs
        path: logs/
        retention-days: 3
