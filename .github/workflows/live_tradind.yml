name: ๐ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช ุฒูุฏู

on:
  # ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ูุฑ 15 ุฏููู ุงุฒ ุณุงุนุช 03:00 ุชุง 20:30 UTC (06:30 ุชุง 23:30 ุจู ููุช ุงุฑุงู)
  schedule:
    - cron: '*/15 3-20 * * *'

  # ุงูฺฉุงู ุงุฌุฑุง ุฏุณุช ุงุฒ ุทุฑู GitHub Actions
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ุงุฌุฑุง ุฎุงุฑุฌ ุงุฒ ุณุงุนุงุช ุจุงุฒุงุฑุ'
        type: boolean
        default: false
        required: false

jobs:
  run-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    # 1๏ธโฃ ุฏุฑุงูุช ฺฉุฏ ุงุฒ ุฑูพุงุฒุชูุฑ
    - name: ๐ ุฏุฑุงูุช ฺฉุฏ (Checkout)
      uses: actions/checkout@v4

    # 2๏ธโฃ ุชูุธู ูพุงุชูู 3.9
    - name: ๐ ุชูุธู ูพุงุชูู 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3๏ธโฃ ูุตุจ ูุงุจุณุชฺฏโูุง ุณุณุชู ู ฺฉุงููพุงู TA-Lib
    - name: โ๏ธ ูุตุจ ูุงุจุณุชฺฏโูุง ุณุณุชู
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          wget \
          libtool \
          automake \
          g++ \
          make

    # 4๏ธโฃ ุฏุงูููุฏ ู ฺฉุงููพุงู TA-Lib ุงุฒ ุณูุฑุณ
    - name: ๐ฝ ุฏุงูููุฏ ู ฺฉุงููพุงู TA-Lib
      run: |
        echo "โฌ๏ธ ุฏุงูููุฏ TA-Lib..."
        wget https://downloads.sourceforge.net/project/ta-lib/ta-lib/0.4.0/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib

        echo "๐ง ูพฺฉุฑุจูุฏ..."
        ./configure --prefix=/usr

        echo "๐จ ฺฉุงููพุงู..."
        make -j$(nproc)

        echo "โ ูุตุจ ุฏุฑ ุณุณุชู..."
        sudo make install

        echo "๐งน ูพุงฺฉโุณุงุฒ..."
        cd ..
        rm -rf ta-lib-0.4.0-src.tar.gz ta-lib

        # ุจุงุฑฺฏุฑ ูุฌุฏุฏ ฺฉุชุงุจุฎุงููโูุง ุณุณุชู
        sudo ldconfig

    # 5๏ธโฃ ุชูุธู ูุณุฑ ฺฉุชุงุจุฎุงููโูุง ุจุฑุง ูพุงุชูู
    - name: ๐ ุชูุธู LD_LIBRARY_PATH
      run: |
        echo "export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib" >> $GITHUB_ENV

    # 6๏ธโฃ ุจุฑุฑุณ ูุฒฺฉ ูุตุจ ฺฉุชุงุจุฎุงูู
    - name: ๐ ุจุฑุฑุณ ฺฉุชุงุจุฎุงูู TA-Lib ุฏุฑ ุณุณุชู
      run: |
        echo "๐ ุฌุณุชุฌู ฺฉุชุงุจุฎุงููโูุง TA-Lib..."
        ldconfig -p | grep -i ta_lib || echo "โ๏ธ ฺฉุชุงุจุฎุงูู ูพุฏุง ูุดุฏ."

    # 7๏ธโฃ ูุตุจ ฺฉุชุงุจุฎุงููโูุง ูพุงุชูู
    - name: ๐ฆ ูุตุจ ฺฉุชุงุจุฎุงููโูุง ูพุงุชูู
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install -r requirements.txt

    # 8๏ธโฃ ุชุณุช ูุงุฑุฏ ฺฉุฑุฏู talib ูุจู ุงุฒ ุงุฌุฑุง
    - name: ๐งช ุชุณุช ูุงุฑุฏ ฺฉุฑุฏู ูุงฺูู talib
      run: |
        python -c "
        try:
            import talib
            print(f'๐ ูููู! TA-Lib ูุงุฑุฏ ุดุฏ. ูุณุฎู: {talib.__version__}')
        except ImportError as e:
            print(f'โ ุฎุทุง ุฏุฑ ูุงุฑุฏ ฺฉุฑุฏู talib: {e}')
            exit(1)
        "

    # 9๏ธโฃ ุงุฌุงุฏ ูพูุดูโูุง ุถุฑูุฑ
    - name: ๐ ุงุฌุงุฏ ูพูุดูโูุง ูุงฺฏ ู ูุชุงุฌ
      run: |
        mkdir -p logs results src/logs src/results
        touch logs/trading.log
        echo "โ ูพูุดูโูุง ุงุฌุงุฏ ุดุฏูุฏ."

    # ๐ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช
    - name: โถ๏ธ ุงุฌุฑุง ุณุณุชู ูุนุงููุงุช (ุญุงูุช ุฒูุฏู)
      run: |
        cd src && python main.py --mode live

    # 1๏ธโฃ1๏ธโฃ ุขูพููุฏ ูุงฺฏโูุง ุจุฑุง ุฏุจุงฺฏ (ุฏุฑ ูุฑ ุตูุฑุช)
    - name: ๐ ุขูพููุฏ ูุงฺฏโูุง
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-logs
        path: logs/
        retention-days: 3
