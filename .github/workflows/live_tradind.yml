import os
import time
import schedule
from datetime import datetime, time as dt_time, timedelta
from exchange_connector import ExchangeConnector
from strategy_engine import InstitutionalStrategy
from trade_logger import TradeLogger
from telegram_bot import send_signal
from config import SYMBOL, TIMEFRAME

class LiveTrading:
    def __init__(self):
        self.connector = ExchangeConnector()
        self.strategy = InstitutionalStrategy()
        self.logger = TradeLogger()
        self.last_signal = None

    def is_market_open(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§Ø² Ø§Ø³Øª (03:00 ØªØ§ 20:30 UTC)"""
        now = datetime.utcnow()
        market_open = dt_time(3, 0)
        market_close = dt_time(20, 30)
        return market_open <= now.time() <= market_close

    def time_until_open(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¨Ø§Ø²Ø§Ø±"""
        now = datetime.utcnow()
        if now.time() > dt_time(20, 30):
            # ÙØ±Ø¯Ø§ Ø³Ø§Ø¹Øª 03:00
            next_open = (now + timedelta(days=1)).replace(hour=3, minute=0, second=0)
        else:
            # Ø§Ù…Ø±ÙˆØ² Ø³Ø§Ø¹Øª 03:00
            next_open = now.replace(hour=3, minute=0, second=0)
        return (next_open - now).total_seconds()

    def check_market(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø± Ùˆ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„Ù‡Ø§"""
        try:
            if not self.is_market_open():
                print(f"â³ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª. Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¯Ø± {self.time_until_open()/60:.1f} Ø¯Ù‚ÛŒÙ‚Ù‡")
                return

            print(f"\nğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC")
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±
            df = self.connector.fetch_data(symbol=SYMBOL, interval=TIMEFRAME, limit=100)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÛŒÚ¯Ù†Ø§Ù„
            df = self.strategy.calculate(df)
            latest = df.iloc[-1]
            
            if latest['signal'] == 1 and self.last_signal != latest['timestamp']:
                signal_data = {
                    'symbol': SYMBOL,
                    'signal': 1,
                    'entry': latest['close'],
                    'sl': latest['stop_loss'],
                    'tp': latest['take_profit'],
                    'timestamp': latest['timestamp'].strftime("%Y-%m-%d %H:%M:%S")
                }
                
                self.logger.log_signal(signal_data)
                send_signal(signal_data)
                self.last_signal = latest['timestamp']
                print(f"ğŸš€ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯! Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯: {signal_data['entry']:.2f}")
            else:
                print("ğŸ” Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯")
                
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø±: {str(e)}")

    def start(self, interval=900):
        """Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ"""
        print("ğŸš€ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø²Ù†Ø¯Ù‡")
        print(f"ğŸ” Ù†Ù…Ø§Ø¯: {SYMBOL} | ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…: {TIMEFRAME}")
        print
